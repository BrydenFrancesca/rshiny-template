language: none

# node_js:
#   - #language version

# services:
#   - #any supported service

# env:
#   - #env1=foo
#   - #env2=bar

env:
  - secure: VHlF2bdUxQy7UeBuId3RmNRkJYI8b26JxOo8sdqlaNCGeOBOVaCv2jUMEjNXLV9b7agbEayAn01H2dReibawrKSFcm93bFn5o67o8raGy7OZ8AIRsnntCp14xD1ewGUsu/Ci0/dPFRQOiS+TBY/gW3YpKrhfGYeN8wRlw7L+AikpJBnsCHpqhViu7eNwUpj+tIXGxxlkqSHbj1IqCbEdrZ1wqs0jyzfakxOIctoaAAUKw5SNJSRdgOoZxf36ZZhkksZq4f0xBISwJqErYGJr31Q2SZRuxo84nZsF/Of8sE4JOVvCAIGeGMKhwTNuD3hc/MInRij+BV2xh2llVhSoWQ==

# matrix:

build:
  pre_ci_boot:
    image_name: quay.io/mojanalytics/analytics-ci
    image_tag: latest
    pull: true
    options: "-e HOME=/root"

  ci:
    - aws configure set default.region eu-west-1
    - aws configure set aws_access_key_id ${ECR_ACCESS_KEY_ID}
    - aws configure set aws_secret_access_key ${ECR_SECRET_ACCESS_KEY}
    - $(aws ecr get-login)
    - docker build -t ${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com/${REPO_NAME}:$(echo ${COMMIT}| cut -c1-8) -t ${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com/${REPO_NAME}:latest .
  post_ci:
    - if ! aws ecr describe-repositories --repository-names ${REPO_NAME} > /dev/null 2>&1; then aws ecr create-repository --repository-name ${REPO_NAME}; fi
    - docker push ${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com/${REPO_NAME}:$(echo ${COMMIT}| cut -c1-8)
    - docker push ${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com/${REPO_NAME}:latest
  # on_success:
  #   - #command1
  #   - #command2
  # on_failure:
  #   - #command1
  #   - #command2
  # cache:
  # cache_dir_list:
  #   - #dir1
  # push:

# integrations:
#  notifications:
#    - integrationName:
#      type:
#      recipients:
#        - #recp1
#        - #recp2

  hub:
    - integrationName: ecr-integration
      type: ecr
      region: eu-west-1
      branches:
        only:
          - master
