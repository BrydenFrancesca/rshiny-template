language: none

env:
  global:
    - DOCKER_IMAGE_NAME=593291632749.dkr.ecr.eu-west-1.amazonaws.com/${REPO_NAME}
    - DOCKER_TAG=$(echo ${COMMIT}| cut -c1-8)

build:
  ci:
    - docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} .
    - docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} ${DOCKER_IMAGE_NAME}:latest
    - echo "tag=${DOCKER_TAG}" >> $JOB_STATE/app-image.env
  post_ci:
    - aws configure set default.region eu-west-1
    - if ! aws ecr describe-repositories --repository-names ${REPO_NAME} > /dev/null 2>&1; then aws ecr create-repository --repository-name ${REPO_NAME}; fi
    - $(aws ecr get-login)
    - docker push ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
    - docker push ${DOCKER_IMAGE_NAME}:latest

integrations:
  hub:
    - integrationName: ecr-integration
      type: ecr
      region: eu-west-1
